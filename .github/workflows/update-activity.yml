name: Update README with Recent Activity

on:
  schedule:
    - cron: "0 */12 * * *" # æ¯ 12 å°æ—¶è¿è¡Œ
  workflow_dispatch: {} # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      # ä½¿ç”¨å®˜æ–¹ GitHub CLI æ‹‰å–æœ€æ–°æ´»åŠ¨ï¼ˆæ”¯æŒ commit/pushï¼‰
      - name: Fetch GitHub Activities
        id: activity
        run: |
          echo "Fetching recent events..."
          gh api users/${{ github.repository_owner }}/events \
            --jq 'map(select(.type=="PushEvent" or .type=="PullRequestEvent" or .type=="IssuesEvent" or .type=="IssueCommentEvent"))[:8]' \
            > activities.json
          cat activities.json

        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ç”Ÿæˆæ¸²æŸ“å†…å®¹
      - name: Generate Activity Markdown
        id: render
        run: |
          echo "Generating markdown..."
          echo "<!--START_ACTIVITY-->" > activity.md
          jq -r '.[] | "* ğŸ¯ \(.type) â†’ \(.repo.name) at \(.created_at)"' activities.json >> activity.md
          echo "<!--END_ACTIVITY-->" >> activity.md
          cat activity.md

      # æ›¿æ¢ README ä¸­çš„æ´»åŠ¨åŒºå—
      - name: Update README
        run: |
          sed -i '/<!--START_ACTIVITY-->/,/<!--END_ACTIVITY-->/{
            /<!--START_ACTIVITY-->/r activity.md
            /<!--START_ACTIVITY-->/!d
          }' README.md

      # æäº¤å˜æ›´
      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git commit -m "ğŸ“Š Update recent activity (Automated)" || exit 0
          git push
